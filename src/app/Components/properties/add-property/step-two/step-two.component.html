<form *ngIf="!showExtendedSection" [formGroup]="basicGroup">
  <div class="step-two-grid">
    <div class="inputs-col">
      <label>
        Country Name
        <select class="add_input" formControlName="country_id">
          <option *ngFor="let c of countries" [value]="c.id">
            {{ c.name }}
          </option>
        </select>
      </label>

      <label>
        City Name
        <select formControlName="city_id">
          <option *ngFor="let c of cities" [value]="c.id">{{ c.name }}</option>
        </select>
      </label>

      <label>
        Additional Info
        <input
          type="text"
          formControlName="additional_info"
          placeholder="Type an address"
        />
      </label>

      <label>Exposure </label>
      <button
        class="add_options font-12 font-400"
        type="button"
        *ngFor="let exp of exposures"
        (click)="toggleSelection('stepTwo.basic.exposures', exp.id)"
        [class.selected]="isSelected('stepTwo.basic.exposures', exp.id)"
      >
        {{ exp.name }}
      </button>
      <label>
        Area (m²)
        <input type="number" formControlName="area" placeholder="Add Area" />
      </label>

      <label>
        Bathrooms
        <input
          type="number"
          formControlName="bathrooms"
          placeholder="Add Number of Bathrooms"
        />
      </label>
      <label>
        Balconies
        <input
          type="number"
          formControlName="balconies"
          placeholder="Add Number of Balconies"
        />
      </label>
      <label>Amenities </label>
      <button
        class="add_options font-12 font-400"
        type="button"
        *ngFor="let amen of amenities"
        (click)="toggleSelection('stepTwo.basic.amenities', amen.id)"
        [class.selected]="isSelected('stepTwo.basic.amenities', amen.id)"
      >
        {{ amen.name }}
      </button>
      <label>Ownership Type </label>
      <button
        class="add_options font-12 font-400"
        type="button"
        *ngFor="let owner of ownership_type_id"
        (click)="toggleSelection('stepTwo.basic.ownership_type_id', owner.id)"
        [class.selected]="
          isSelected('stepTwo.basic.ownership_type_id', owner.id)
        "
      >
        {{ owner.name }}
      </button>
    </div>

    <google-map
      #map
      [center]="center"
      [zoom]="8"
      (mapClick)="onMapClick($event)"
    >
      <map-marker
        *ngFor="let marker of markers"
        [position]="marker.position"
        [title]="marker.title"
      ></map-marker
    ></google-map>
  </div>
</form>
<!-- Extended-section                                                              Extended -->
<form
  class="extended-section"
  [formGroup]="extendedGroup"
  *ngIf="showExtendedSection"
>
  <div class="sale-section width-50">
    <h3>Select Sell Type</h3>
    <div class="button-group">
      <button
        type="button"
        class="add_options font-12 font-400"
        [ngClass]="{ 'bg-focused': selectedSellType === 1 }"
        (click)="setSellType(1)"
      >
        For Sale
      </button>
      <button
        type="button"
        class="add_options font-12 font-400"
        [ngClass]="{ 'bg-focused': selectedSellType === 2 }"
        (click)="setSellType(2)"
      >
        For Rent
      </button>

      <button
        type="button"
        class="add_options font-12 font-400"
        [ngClass]="{ 'bg-focused': selectedSellType === 3 }"
        (click)="setSellType(3)"
      >
        Off Plan
      </button>
    </div>
    <div class="details-grid inputs-col">
      <div *ngIf="selectedSellType === 2" formGroupName="rent">
        <label
          >Price
          <input
            type="number"
            formControlName="price"
            placeholder="e.g. 12 months"
          />
        </label>
        <label>
          Lease Period Value
          <input
            type="number"
            formControlName="lease_period_value"
            placeholder="e.g. 12 months"
          />
        </label>
        <label>Lease Period Unit </label>
        <div class="furnished-toggle">
          <button
            class="add_options font-12 font-400"
            type="button"
            [ngClass]="{
              'bg-focused': rentUnit === 0
            }"
            (click)="sendRentUnit('Month', 0)"
          >
            Month
          </button>

          <button
            class="add_options font-12 font-400"
            type="button"
            [ngClass]="{
              'bg-focused': rentUnit === 1
            }"
            (click)="sendRentUnit('Year', 1)"
          >
            Year
          </button>
        </div>
        <label> Furnished </label>
        <div class="furnished-toggle">
          <button
            class="add_options font-12 font-400"
            type="button"
            [ngClass]="{
              'bg-focused': isfurnitured === 1
            }"
            (click)="swichFurnitured(1)"
          >
            Yes
          </button>

          <button
            class="add_options font-12 font-400"
            type="button"
            [ngClass]="{
              'bg-focused': isfurnitured === 0
            }"
            (click)="swichFurnitured(0)"
          >
            No
          </button>
        </div>
      </div>
      <div *ngIf="selectedSellType === 1" formGroupName="purchase">
        <label
          >Price
          <input type="number" formControlName="price" />
        </label>
        <label> Furnished </label>
        <div>
          <button
            class="add_options font-12 font-400"
            type="button"
            [ngClass]="{
              'bg-focused': isfurnitured === 1
            }"
            (click)="swichFurnitured(1)"
          >
            Yes
          </button>

          <button
            class="add_options font-12 font-400"
            type="button"
            [ngClass]="{
              'bg-focused': isfurnitured === 0
            }"
            (click)="swichFurnitured(0)"
          >
            No
          </button>
        </div>
      </div>

      <div *ngIf="selectedSellType === 3" formGroupName="offPlan">
        <!-- Delivery date -->
        <label>
          Delivery Date
          <input type="date" formControlName="delivery_date" />
        </label>

        <!-- Overall payment (text for now) -->
        <label>
          Overall Payment
          <input type="text" formControlName="overall_payment" />
        </label>

        <!-- LIVE Remaining % box -->
        <div class="remaining-wrap" style="margin-top: 12px">
          <ng-container *ngIf="anySelected; else noneSelected">
            <div class="remaining">
              Remaining:
              <span [ngClass]="remainingClass()">{{ remaining }}</span
              >%
            </div>
            <div class="small-hint">
              Sum: {{ percentSum }}% —
              {{
                remaining === 0
                  ? "Good ✅"
                  : remaining > 0
                  ? remaining + " more % needed"
                  : Math.abs(remaining) + "% over"
              }}
            </div>
          </ng-container>
          <ng-template #noneSelected>
            <div class="remaining neutral">No phases selected</div>
          </ng-template>
        </div>

        <!-- payment_phases list -->
        <div formArrayName="payment_phases" style="margin-top: 10px">
          <div
            *ngFor="let p of paymentPhases?.controls; let i = index"
            [formGroupName]="i"
            class="phase-row"
            style="margin-bottom: 10px"
          >
            <label>
              <input type="checkbox" formControlName="selected" />
              {{ formSvc.phases[i] | titlecase }}
            </label>

            <!-- payment percentage -->
            <input
              type="number"
              formControlName="payment_percentage"
              placeholder="% (integer)"
              [class.pct-mismatch]="shouldHighlightPercentInput(i)"
              style="width: 100px; margin-left: 8px"
            />

            <!-- duration inputs -->
            <input
              type="number"
              formControlName="duration_value"
              placeholder="duration"
              style="width: 90px; margin-left: 8px"
            />

            <select
              formControlName="duration_unit"
              style="width: 110px; margin-left: 8px"
            >
              <option [ngValue]="null">--</option>
              <option value="months">months</option>
              <option value="years">years</option>
            </select>

            <!-- inline validation hints for percentage (null-safe) -->
            <div
              *ngIf="
                phaseAt(i)?.get('payment_percentage')?.invalid &&
                phaseAt(i)?.get('payment_percentage')?.touched
              "
            >
              <small
                *ngIf="phaseAt(i)?.get('payment_percentage')?.errors?.['required']"
                >Percentage is required.</small
              >
              <small
                *ngIf="phaseAt(i)?.get('payment_percentage')?.errors?.['pattern']"
                >Must be integer.</small
              >
              <small
                *ngIf="
                  phaseAt(i)?.get('payment_percentage')?.errors?.['min'] ||
                  phaseAt(i)?.get('payment_percentage')?.errors?.['max']
                "
                >0 - 100</small
              >
            </div>
          </div>
        </div>

        <!-- offPlan-level error from validator (null-safe and bracket notation) -->
        <div
          *ngIf="offPlanGroup?.errors?.['percentageTotalNot100']"
          class="error"
          style="margin-top: 8px"
        >
          <small>
            Selected payment phases percentages must sum to 100%. Current total:
            {{ offPlanGroup?.errors?.['percentageTotalNot100']?.sum ?? percentSum












            }}%
          </small>
        </div>
      </div>
    </div>
  </div>
  <!-- Second part -->
  <div class="property-section width-50">
    <h3>Select Property Type</h3>
    <div class="button-group">
      <button
        type="button"
        class="add_options font-12 font-400"
        [ngClass]="{ 'bg-focused': selectedPropertyType === 1 }"
        (click)="setPropertyType(1)"
      >
        Apartment
      </button>
      <button
        type="button"
        class="add_options font-12 font-400"
        [ngClass]="{ 'bg-focused': selectedPropertyType === 2 }"
        (click)="setPropertyType(2)"
      >
        Villa
      </button>
      <button
        type="button"
        class="add_options font-12 font-400"
        [ngClass]="{ 'bg-focused': selectedPropertyType === 3 }"
        (click)="setPropertyType(3)"
      >
        Office
      </button>
    </div>
    <div class="details-grid inputs-col">
      <div *ngIf="selectedPropertyType === 1" formGroupName="apartment">
        <label
          >Number of Bedrooms
          <input type="number" formControlName="bedrooms" />
        </label>
        <label
          >Floor Number
          <input type="number" formControlName="floor" />
        </label>
        <label
          >Building Number
          <input type="number" formControlName="building_number" />
        </label>
        <label
          >Apartment Number
          <input type="number" formControlName="apartment_number" />
        </label>
      </div>

      <!-- Villa Form -->
      <div *ngIf="selectedPropertyType === 2" formGroupName="villa">
        <label
          >Number of Bedrooms
          <input type="number" formControlName="bedrooms" />
        </label>
        <label
          >Number of Floors
          <input type="number" formControlName="floors" />
        </label>
      </div>

      <!-- Commercial/Office Form -->
      <div *ngIf="selectedPropertyType === 3" formGroupName="office">
        <label
          >Floor Number
          <input type="number" formControlName="floor" />
        </label>
        <label
          >Building Number
          <input type="number" formControlName="building_number" />
        </label>
        <label
          >Apartment Number
          <input type="number" formControlName="apartment_number" />
        </label>
      </div>
    </div>
  </div>
</form>
